import os
import datetime
import pytz
import asyncio
from telegram import Bot, LinkPreviewOptions

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
TIMEZONE_STR = os.getenv("TIMEZONE", "Europe/Kyiv")
TARGET_HOUR = 8  # –¶–µ–ª–µ–≤–æ–π —á–∞—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ (08:00)
TARGET_MINUTE = 0

# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –≥—Ä—É–ø–ø –∏ –∏—Ö —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
# –û–±–æ–∑–Ω–∞—á–µ–Ω–∏—è –¥–Ω–µ–π: "0": –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, "1": –í—Ç–æ—Ä–Ω–∏–∫, ... "6": –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
GROUPS_DATA = [
    {
        "group": "–ë–∞—Ä–∞–∫—É–¥–∞",
        "address": "–≤—É–ª. –õ–∞—Ä–∏—Å–∏ –†—É–¥–µ–Ω–∫–æ, 3 (–ø—Ä–∏–º—ñ—â–µ–Ω–Ω—è –∫–ª—ñ–Ω—ñ–∫–∏), –∫–∞–±i–Ω–µ—Ç 008 (—Å—Ö–æ–¥–∏ –≤–Ω–∏–∑, –∑–ª—ñ–≤–∞ –≤—ñ–¥ —Ä–µ—Å–µ–ø—à–µ–Ω–∞)",
        "description": "",
        "schedule": {"1": "20:00-21:00", "6": "16.00-17.15"},
        "directions": ""
    },
    {
        "group": "–ù–∞ –ü–æ–∑–Ω—è–∫–∞—Ö",
        "address": "–•–∞—Ä–∫—ñ–≤—Å—å–∫–µ —à–æ—Å–µ 57, –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—è —Å–æ—Ü. —Å–ª—É–∂–±–∏ –Ω–∞ –¥—Ä—É–≥–æ–º—É –ø–æ–≤–µ—Ä—Å—ñ.",
        "description": "",
        "schedule": {
            "0": "19:00-20:15", "1": "19:00-20:15", "2": "19:00-20:15",
            "3": "19:00-20:15", "4": "19:00-20:15", "5": "13:00-14:00, 19:00-20:15", "6": "19:00-20:15"
        },
        "directions": ""
    },
    {
        "group": "–í—ñ–Ω—Ç–∞–∂",
        "address": "–Ü–≤–∞–Ω–∞ –ú–∏–∫–æ–ª–∞–π—á—É–∫–∞, 11",
        "description": "–î—Ä—É–≥–∏–π –ø–æ–≤–µ—Ä—Ö",
        "schedule": {"3": "19:00", "4": "19:00", "5": "19:00"},
        "directions": ""
    },
    {
        "group": "–í–∏—à–Ω—è",
        "address": "–º. –í–∏—à–Ω–µ–≤–µ, –≤—É–ª. –°–≤—è—Ç–æ—à–∏–Ω—Å—å–∫–∞ 42 ( –≤—Ö—ñ–¥ –≤—ñ–¥ –ø—Ä–æ—ó–∑–¥–∂–æ—ó —á–∞—Å—Ç–∏–Ω–∏, –¥–≤–µ—Ä—ñ –∑ –Ω–∞–ø–∏—Å–æ–º '–ö–æ–ª–æ —Å–∏–ª–∏')",
        "description": "",
        "schedule": {"6": "18.00-19.00"},
        "directions": ""
    },
    {
        "group": "–¢i–ª—å–∫–∏ –°—å–æ–≥–æ–¥–Ωi",
        "address": "https://t.me/+rAqy7n9GjfQ3MjYy",
        "description": "Telegram",
        "schedule": {
            "0": "08:00, 17:00, 21:00",
            "1": "08:00, 17:00, 21:00",
            "2": "08:00, 17:00, 21:00",
            "3": "08:00, 17:00, 21:00",
            "4": "08:00, 17:00, 21:00",
            "5": "08:00, 17:00, 21:00, 1:00 (–ù—ñ—á–Ω–∞ –≥—Ä—É–ø–∞)",
            "6": "08:00, 17:00, 21:00, 1:00 (–ù—ñ—á–Ω–∞ –≥—Ä—É–ø–∞)"
        },
        "directions": ""
    },
    {
        "group": "–ù–∞ —á–∞—Å—ñ",
        "address": "–≤—É–ª. –ú–µ–∂–∏–≥—ñ—Ä—Å—å–∫–∞ 22 (–≤—Ö—ñ–¥ —É –¥–≤–æ—Ä—ñ, –ø–æ–¥‚Äô—ó–∑–¥ –∑ —Ü–∏—Ñ—Ä–æ—é –ø‚Äô—è—Ç—å)",
        "description": "–Ø–∫—â–æ –¥–æ–º–æ—Ñ–æ–Ω –Ω–µ –ø—Ä–∞—Ü—é—î, –∑–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É–π—Ç–µ –∑–∞ –Ω–æ–º–µ—Ä–æ–º:  380984170324, –ø–æ—à—Ç–∞: nachasi.nagroup.kyivbased@gmail.com",
        "schedule": {
            "0": "13:00-14:00", "1": "13:00-14:00", "2": "13:00-14:00",
            "3": "13:00-14:00", "4": "13:00-14:00", "5": "13:00-14:00", "6": "13:00-14:00"
        },
        "directions": "https://youtube.com/shorts/Q7RRhGDwpTw?feature=share"
    },
    {
        "group": "–úayday",
        "address": "–≤—É–ª.–ö—Ä—É–≥–ª–æ—É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—Å—å–∫–∞, 7 —Ä-–Ω –ë–µ—Å—Å–∞—Ä–∞–±—Å—å–∫–æ—ó –ø–ª. –º.–•—Ä–µ—â–∞—Ç–∏–∫ (–Ω–∞–ø—ñ–≤–ø—ñ–¥–≤–∞–ª—å–Ω–µ –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—è –Ω–∞ —Ä–æ–∑—ñ)",
        "description": "–ü–æ —Å—É–±–æ—Ç–∞—Ö –∑—ñ–±—Ä–∞–Ω–Ω—è —î –≤—ñ–¥–∫—Ä–∏—Ç–∏–º–∏, –º–æ–∂—É—Ç—å –ø—Ä–∏—Ö–æ–¥–∏—Ç–∏ –Ω–µ–∑–∞–ª–µ–∂–Ω—ñ –≥–æ—Å—Ç—ñ.",
        "schedule": {
            "0": "19:00-20:15", "1": "19:00-20:15", "2": "19:00-20:15",
            "3": "19:00-20:15", "4": "19:00-20:15", "5": "19:00-20:15", "6": "19:00-20:15"
        },
        "directions": ""
    },
    {
        "group": "–úayday online",
        "address": "https://t.me/maydayonline",
        "description": "Telegram",
        "schedule": {
            "0": "8:00, 12:00-13:00, 21:00-22:15",
            "1": "8:00, 12:00-13:00, 21:00-22:15",
            "2": "8:00, 12:00-13:00, 21:00-22:15",
            "3": "8:00, 12:00-13:00, 21:00-22:15",
            "4": "8:00, 12:00-13:00, 21:00-22:15, 23:00",
            "5": "8:00, 12:00-13:00, 21:00-22:15, 23:00",
            "6": "8:00, 12:00-13:00, 21:00-22:15, 23:00"
        },
        "directions": ""
    },
    {
        "group": "NA –¢—Ä–æ—î—â–∏–Ω—ñ",
        "address": "–≤—É–ª. –°–µ—Ä–∂–∞ –õ–∏—Ñ–∞—Ä—è (–°–∞–±—É—Ä–æ–≤–∞) 20, –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—è –∂–µ–∫–∞ 313",
        "description": "",
        "schedule": {
            "0": "19:00", "1": "19:00", "2": "19:00", "3": "19:00-20:00",
            "4": "19:00", "5": "19:00", "6": "19:00"
        },
        "directions": ""
    },
    {
        "group": "–ü–∞—Ä—É—Å",
        "address": "–≤—É–ª. –î–æ–≤–∂–µ–Ω–∫–∞, 2. –ú. –®—É–ª—è–≤—Å—å–∫–∞ (—É –ø—ñ–¥–≤–∞–ª—ñ)",
        "description": "–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω: 066 16 65 149",
        "schedule": {
            "0": "19:00-20:30", "1": "19:00-20:30", "3": "19:00-20:30",
            "4": "19:00-20:30", "5": "19:00-20:30", "6": "19:00-20:30"
        },
        "directions": "https://youtu.be/RR4sWOMn-AM"
    },
    {
        "group": "–°—Ç–∞–ª—å",
        "address": "–≤—É–ª. –ú–∞—Ä–∏—á–∞–Ω—Å—å–∫–∞ 5",
        "description": "",
        "schedule": {"1": "19:00", "3": "19:00", "5": "17:00"},
        "directions": "https://youtu.be/KSnhnQy936M"
    },
    {
        "group": "–ë—É—á-–ê–ù-–∫–∞",
        "address": "–º. –ë—É—á–∞. –≤—É–ª. –ñ–æ–≤—Ç–Ω–µ–≤–∞ 66 –¢–†–¶ –ë—É—á–∞ - –ü–∞—Å—Å–∞–∂ 3 –ø–æ–≤–µ—Ä—Ö. –ö—ñ–º–Ω–∞—Ç–∞ 136–ê",
        "description": "",
        "schedule": {"0": "19:30-20:30", "2": "19:30-20:30", "4": "19:30-20:30"},
        "directions": ""
    },
    {
        "group": "–ù–∞–º –Ω–µ –≤—Å–µ –æ–¥–Ω–æ",
        "address": "–ø—Ä. –ì–æ–Ω–≥–∞–¥–∑–µ 20 (–∑–∞ –ï–∫–æ–º–∞—Ä–∫–µ—Ç –º–∞–ª–µ–Ω—å–∫–∞ –±—É–¥—ñ–≤–ª—è –∑ –≤–µ—Ç–∫–ª—ñ–Ω—ñ–∫–æ—é –Ω–∞ —Ä–æ–∑—ñ)",
        "description": "",
        "schedule": {
            "0": "19:00-20:00", "1": "19:00-20:00", "2": "19:00-20:00",
            "3": "19:00-20:00", "4": "19:00-20:00", "5": "19:00-20:00", "6": "19:00-20:00"
        },
        "directions": ""
    },
    {
        "group": "–í–æ—Å–∫—Ä—î—Å—î–Ω–∫–∞",
        "address": "–≤—É–ª–∏—Ü—è –ú–∏–∫—ñ–ª—å—Å—å–∫–æ-–°–ª–æ–±—ñ–¥—Å—å–∫–∞, 5",
        "description": "–î–ª—è —É—Ç–æ—á–Ω–µ–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –∑—ñ–±—Ä–∞–Ω–Ω—è –≥—Ä—É–ø–∏ –∑–≤–µ—Ä—Ç–∞–π—Ç–µ—Å—è –¥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–Ω–∏–∫—ñ–≤ –≥—Ä—É–ø–∏, —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –∑–≤'—è–∑–∫—É: 067 325 11 77",
        "schedule": {"2": "17.30", "4": "17.30"},
        "directions": ""
    },
    {
        "group": "–°–æ–ª–æ–º'—è–Ω–∫–∞",
        "address": "–≤—É–ª. –ú–∞–∫—Å–∏–º–∞ –ö—Ä–∏–≤–æ–Ω–æ—Å–∞ 21",
        "description": "",
        "schedule": {"0": "19.00-20.00", "4": "19.00-20.00", "6": "17.00-18.00"},
        "directions": ""
    },
    {
        "group": "–í –ë—Ä–æ–≤–∞—Ä–∞—Ö",
        "address": "–º. –ë—Ä–æ–≤–∞—Ä–∏, –≤—É–ª–∏—Ü—è –ì–µ—Ä–æ—ó–≤ –£–∫—Ä–∞—ó–Ω–∏ 26, 4 –ø–æ–≤–µ—Ä—Ö, –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—è –ª—ñ–≤–æ—Ä—É—á (–∫–∞–±.401)",
        "description": "–¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –¥–æ–≤—ñ–¥–æ–∫: 0636239058",
        "schedule": {
            "0": "19.00-20.00", "1": "19.00-20.00", "2": "19.00-20.00",
            "3": "19.00-20.00", "4": "19.00-20.00", "5": "13.00-14.00", "6": "13.00-14.00"
        },
        "directions": ""
    },
    {
        "group": "–ë–æ—è—Ä–∫–∞",
        "address": "–º.–ë–æ—è—Ä–∫–∞, –≤—É–ª –Ø—Ä–æ—Å–ª–∞–≤–∞ –º—É–¥—Ä–æ–≥–æ (–î–µ–∂–Ω–µ–≤–∞), 62",
        "description": "–ü—Ä–∏–º—ñ—â–µ–Ω–Ω—è —Å–æ—Ü—ñ–∞–ª—å–Ω–æ—ó —Å–ª—É–∂–±–∏ (—Å—ñ—Ä–∞ –±—É–¥—ñ–≤–ª—è), –ù–æ–º–µ—Ä –¥–ª—è –∑–≤'—è–∑–∫—É  380992851660",
        "schedule": {"5": "16:00"},
        "directions": ""
    },
    {
        "group": "–í–∏—à–≥–æ—Ä–æ–¥",
        "address": "–º.–í–∏—à–≥–æ—Ä–æ–¥, –ø—Ä–æ—Å–ø–µ–∫—Ç –®–µ–≤—á–µ–Ω–∫–∞ 6",
        "description": "–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω: 067-219-40-61 –û–ª–µ–∫—Å–∞–Ω–¥—Ä",
        "schedule": {"0": "19:00"},
        "directions": ""
    },
    {
        "group": "–í–£–ê–ù (–í–µ—Ç–µ—Ä–∞–Ω–∏ –£–∫—Ä–∞—ó–Ω–∏ –ê–Ω–æ–Ω—ñ–º–Ω—ñ –ù–∞—Ä–∫–æ–º–∞–Ω–∏)",
        "address": "–í—É–ª. –†–æ–≥–Ω–∏–¥–∏–Ω—Å—å–∫–∞, 3 (–∫–æ–¥ 236) –∫—ñ–º.4",
        "description": "–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω: 096-788-64-90 –ï–≤–≥–µ–Ω—ñ–π",
        "schedule": {"5": "13:00-14:00"},
        "directions": ""
    }
]

def format_schedule(weekday_idx):
    """–§–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –æ –≥—Ä—É–ø–ø–∞—Ö"""
    day_str = str(weekday_idx)
    
    # –°—Ä–µ–¥–∞ ‚Äî "–î–æ–±—Ä–∏–π –¥–µ–Ω—å!", –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî "–î–æ–±—Ä–∏–π —Ä–∞–Ω–æ–∫!"
    greeting = "üåû –î–æ–±—Ä–∏–π –¥–µ–Ω—å!" if weekday_idx == 2 else "üåû –î–æ–±—Ä–∏–π —Ä–∞–Ω–æ–∫!"
    
    message = f"{greeting}\n–†–æ–∑–∫–ª–∞–¥ –∑—ñ–±—Ä–∞–Ω–Ω—å –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ:\n\n"
    body = ""
    
    for item in GROUPS_DATA:
        time = item["schedule"].get(day_str)
        if time:
            body += f"üîπ –ì—Ä—É–ø–∞: <b>{item['group']}</b>\n"
            
            # –ï—Å–ª–∏ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –µ—Å—Ç—å –º–µ—Ç–∫–∞ Telegram ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë
            if item.get("description") == "Telegram":
                body += f"Telegram: {item['address']}\n"
            else:
                body += f"–ê–¥—Ä–µ—Å–∞: {item['address']}\n"
                
            body += f"–ß–∞—Å: {time}\n"
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å –∏ —ç—Ç–æ –Ω–µ "Telegram")
            if item.get("description") and item.get("description") != "Telegram":
                body += f"{item['description']}\n"
                
            # –ö–∞–∫ –ø—Ä–æ–π—Ç–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
            if item.get("directions"):
                body += f"–Ø–∫ –ø—Ä–æ–π—Ç–∏ –¥–æ –Ω–∞—Å: {item['directions']}\n"
                
            body += "\n"
            
    if not body:
        return message + "–°—å–æ–≥–æ–¥–Ω—ñ –∑–∞—Ö–æ–¥—ñ–≤ –Ω–µ–º–∞—î."
        
    return message + body

async def main():
    if not TOKEN or not CHAT_ID:
        print("–û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –∏–ª–∏ ID —á–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!")
        return

    bot = Bot(token=TOKEN)
    tz = pytz.timezone(TIMEZONE_STR)
    now = datetime.datetime.now(tz)
    
    # === –õ–æ–≥–∏–∫–∞ —Ç–æ—á–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ ===
    # –¶–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–µ–≥–æ–¥–Ω—è
    target_time = now.replace(hour=TARGET_HOUR, minute=TARGET_MINUTE, second=0, microsecond=0)
    
    # –ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω —Ä–∞–Ω—å—à–µ —Ü–µ–ª–µ–≤–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ 07:35), –∂–¥–µ–º
    if now < target_time:
        wait_seconds = (target_time - now).total_seconds()
        print(f"–°–µ–π—á–∞—Å {now.strftime('%H:%M:%S')}. –ñ–¥–µ–º {wait_seconds:.0f} —Å–µ–∫—É–Ω–¥ –¥–æ {TARGET_HOUR}:{TARGET_MINUTE:02d}...")
        
        # –ñ–¥–µ–º. –ï—Å–ª–∏ –æ–∂–∏–¥–∞–Ω–∏–µ –±–æ–ª—å—à–µ —á–∞—Å–∞ (—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞), —Ç–æ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫, –Ω–æ –º—ã –∂–¥–µ–º –≤—Å—ë —Ä–∞–≤–Ω–æ.
        await asyncio.sleep(wait_seconds)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ —Å–Ω–∞
        now = datetime.datetime.now(tz)
    else:
        print(f"–°–µ–π—á–∞—Å {now.strftime('%H:%M:%S')}. –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ {TARGET_HOUR}:{TARGET_MINUTE:02d} —É–∂–µ –Ω–∞—Å—Ç—É–ø–∏–ª–æ –∏–ª–∏ –ø—Ä–æ—à–ª–æ. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ä–∞–∑—É.")
    # ==============================
    
    weekday_idx = now.weekday()
    message = format_schedule(weekday_idx)
    
    print(f"–û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–∞ –¥–µ–Ω—å {weekday_idx}...")
    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤
        await bot.send_message(
            chat_id=CHAT_ID, 
            text=message, 
            parse_mode="HTML",
            link_preview_options=LinkPreviewOptions(is_disabled=True)
        )
        print("–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: {e}")

if __name__ == "__main__":
    asyncio.run(main())
